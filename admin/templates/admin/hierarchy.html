{% extends 'admin/base.html' %}
{% block body %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Category Hierarchy</h2>
    <div>
      <span class="me-2">Maintenance Mode:</span>
      <button class="btn btn-sm btn-outline-warning" id="maintenance-toggle" disabled>Toggle (UI only)</button>
      <span class="badge bg-secondary ms-2">Status: <span id="maintenance-status">Unknown</span></span>
    </div>
  </div>
  {% for cat in hierarchy %}
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <button class="btn btn-sm btn-light me-2" type="button" data-bs-toggle="collapse" data-bs-target="#cat-{{ cat.category_group_id }}" aria-expanded="false" aria-controls="cat-{{ cat.category_group_id }}">
          <span class="bi bi-chevron-right"></span>
        </button>
        <span><strong>{{ cat.display_name or cat.category_group_id }}</strong></span>
        <div class="form-check form-switch ms-auto">
          <input class="form-check-input category-toggle" type="checkbox" id="cat-toggle-{{ cat.category_group_id }}" data-category-id="{{ cat.category_group_id }}" {% if cat.include %}checked{% endif %} aria-checked="{{ 'true' if cat.include else 'false' }}" aria-label="Enable category {{ cat.display_name or cat.category_group_id }}" disabled>
          <label class="form-check-label" for="cat-toggle-{{ cat.category_group_id }}">Enabled</label>
        </div>
      </div>
      <div class="collapse" id="cat-{{ cat.category_group_id }}">
        <div class="card-body">
          <!-- Dynamic content will be loaded here -->
        </div>
      </div>
    </div>
  {% endfor %}
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
  .card { border-radius: 0.5rem; }
  .card-header { font-size: 1.1rem; }
  .form-switch { margin-bottom: 0; }
  .ms-4 { margin-left: 1.5rem !important; }
  .btn[disabled] { pointer-events: none; opacity: 0.6; }
  @media (max-width: 768px) {
    .card-header, .table th, .table td { font-size: 0.95rem; }
    .ms-4 { margin-left: 0.5rem !important; }
  }
</style>
<script>
// Atomic, truthful maintenance mode toggle logic
const maintenanceToggle = document.getElementById('maintenance-toggle');
const maintenanceStatus = document.getElementById('maintenance-status');
let maintenanceState = null;

function setCategoryTogglesEnabled(enabled) {
  document.querySelectorAll('.category-toggle').forEach(toggle => {
    toggle.disabled = !enabled;
    toggle.setAttribute('aria-disabled', String(!enabled));
  });
}

function updateMaintenanceStatus() {
  fetch('/admin/api/maintenance', { method: 'GET' })
    .then(response => response.json())
    .then(data => {
      maintenanceState = !!data.status;
      maintenanceStatus.textContent = maintenanceState ? 'ON' : 'OFF';
      maintenanceToggle.textContent = maintenanceState ? 'Disable' : 'Enable';
      maintenanceToggle.disabled = false;
      setCategoryTogglesEnabled(maintenanceState);
    })
    .catch(error => {
      maintenanceStatus.textContent = 'Unknown';
      maintenanceToggle.disabled = true;
      setCategoryTogglesEnabled(false);
      console.error('Error fetching maintenance status:', error);
    });
}

maintenanceToggle.addEventListener('click', function() {
  if (maintenanceState === null) return;
  maintenanceToggle.disabled = true;
  // Toggle the state
  fetch('/admin/api/maintenance', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ enable: !maintenanceState })
  })
    .then(response => response.json())
    .then(data => {
      maintenanceState = !!data.status;
      maintenanceStatus.textContent = maintenanceState ? 'ON' : 'OFF';
      maintenanceToggle.textContent = maintenanceState ? 'Disable' : 'Enable';
      maintenanceToggle.disabled = false;
      setCategoryTogglesEnabled(maintenanceState);
    })
    .catch(error => {
      maintenanceToggle.disabled = false;
      setCategoryTogglesEnabled(false);
      console.error('Error toggling maintenance mode:', error);
    });
});

document.addEventListener('DOMContentLoaded', function() {
  updateMaintenanceStatus();

  // Wire up category toggles for enable/disable
  document.querySelectorAll('.category-toggle').forEach(toggle => {
    toggle.addEventListener('change', function() {
      if (!maintenanceState) {
        // Should never happen, but just in case
        this.checked = !this.checked;
        return;
      }
      const catId = this.getAttribute('data-category-id');
      const newState = this.checked;
      this.disabled = true;
      fetch(`/admin/api/category/${catId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ include: newState })
      })
        .then(response => response.json())
        .then(data => {
          // Truthfully reflect backend state
          this.checked = !!data.include;
          this.setAttribute('aria-checked', String(!!data.include));
          this.disabled = false;
        })
        .catch(error => {
          this.disabled = false;
          this.checked = !newState; // revert
          console.error('Error updating category state:', error);
        });
    });
  });

  // Collapse all sections by default
  document.querySelectorAll('.collapse').forEach(element => {
    element.classList.remove('show');
  });

  // Ensure dynamic content is loaded correctly and chevron toggles with Bootstrap collapse events
  document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(twisty => {
    const targetId = twisty.getAttribute('data-bs-target');
    const targetElement = document.querySelector(targetId);

    // Load content on first expand only
    targetElement.addEventListener('show.bs.collapse', function() {
      if (!targetElement.classList.contains('loaded')) {
        const categoryId = targetId.replace('#cat-', '');
        fetch(`/admin/api/category/${categoryId}`)
          .then(response => response.json())
          .then(data => {
            const cardBody = targetElement.querySelector('.card-body');
            cardBody.innerHTML = data.channels.map(channel => `<div>${channel.name}</div>`).join('');
            targetElement.classList.add('loaded');
          })
          .catch(error => {
            console.error('Error loading category data:', error);
          });
      }
    });

    // Chevron icon toggle on collapse/expand
    targetElement.addEventListener('show.bs.collapse', function() {
      twisty.querySelector('.bi').classList.remove('bi-chevron-right');
      twisty.querySelector('.bi').classList.add('bi-chevron-down');
    });
    targetElement.addEventListener('hide.bs.collapse', function() {
      twisty.querySelector('.bi').classList.remove('bi-chevron-down');
      twisty.querySelector('.bi').classList.add('bi-chevron-right');
    });
  });
});
</script>
{% endblock %}
